parameters:
- name: stageName
  default: ''

- name: environmentName
  default: ''

- name: variableGroupName
  default: ''

- name: serviceConnection
  default: ''

stages:
  - stage: ${{ parameters.stageName }}
    displayName: ${{ parameters.stageName }}

    jobs:
    - deployment: Deploy
      displayName: Deploy
      environment: ${{ parameters.environmentName }}
      variables:
      - group: ${{ parameters.variableGroupName }}
      pool:
        vmImage: windows-latest
      strategy:
        runOnce:
          deploy:
            steps:
            - download: current
              artifact: webApp
              displayName: Downlaod Web app artifact
            
            - download: current
              artifact: infrastructure
              displayName: Download infrastructure artifact

            - download: current
              artifact: functionApp
              displayName: Download Function app artifact
            
            - task: AzureCLI@2
              displayName: Deploy infrastructure
              inputs:
                azureSubscription: ${{ parameters.serviceConnection }}
                scriptType: ps
                scriptLocation: inlineScript
                inlineScript: |
                  $date = Get-Date
                  $deploymentNameSuffix = $date.ToString("yyyy-MM-dd-hh-mm-ss")
                  $deploymentName = "main-${deploymentNameSuffix}"
                  
                  az deployment group create -g $(resourceGroupName) -n $deploymentName --template-file $(Pipeline.Workspace)/infrastructure/maintemplate.json --parameters deploymentNameSuffix=$deploymentNameSuffix reportRequestQueueName=$(reportRequestQueueName) reportingStorageAccountName=$(reportingStorageAccountName) appServiceName=$(appServiceName) appServiceSkuName=$(appServiceSkuName) appServiceSkuCapacity=$(appServiceSkuCapacity) keyVaultName=$(keyVaultName) accessPolicyTargetObjectId=$(accessPolicyTargetObjectId) logAnalticsWorkspaceName=$(logAnalticsWorkspaceName) appInsightsName=$(appInsightsName) functionAppName=$(functionAppName) functionAppAppInsightsName=$(functionAppAppInsightsName) functionAppStorageAccountName=$(functionAppStorageAccountName)
            
            - task: AzureRmWebAppDeployment@4
              displayName: 'Deploy Web app'
              inputs:
                ConnectionType: 'AzureRM'
                azureSubscription: ${{ parameters.serviceConnection }}
                appType: 'webApp'
                WebAppName: $(appServiceName)
                Package: '$(Pipeline.Workspace)/webApp/GovtReportingDemo.zip'
            
            - task: AzureFunctionApp@1
              displayName: Deploy Function app
              inputs:
                azureSubscription: ${{ parameters.serviceConnection }}
                appType: functionApp
                appName: $(functionAppName)
                package: $(Pipeline.Workspace)\functionApp\GovtReportingDemo.Functions.zip
            
            - task: AzureCLI@2
              displayName: Set Function app App Settings
              inputs:
                azureSubscription: ${{ parameters.serviceConnection }}
                scriptType: ps
                scriptLocation: inlineScript
                inlineScript: |
                  $reportRequestStorageConnectionString = (az storage account show-connection-string -g $(resourceGroupName) -n $(reportingStorageAccountName) -o tsv) | Out-String
                  az functionapp config appsettings set -n $(functionAppName) -g $(resourceGroupName) --settings "reportRequestStorageConnectionString=$reportRequestStorageConnectionString" "reportRequestQueueName=$(reportRequestQueueName)"
                  az functionapp config appsettings set -n $(functionAppName) -g $(resourceGroupName) --settings "reportRequestQueueName=$(reportRequestQueueName)"

